---
title: 自动化构建.md
tags:
  - 前端
  - 持续集成
  - 自动化构建
categories:
  - 前端
  - 持续集成
  - 自动化构建
date: 2019-04-25 11:27:52
---


![](https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=1855844663,2646560550&fm=26&gp=0.jpg)

## 环境

---
- 阿里云服务器ECS
- Ubuntu 16.04
---

## (一) 修改阿里云ECS默认主机名

---

需要修改两处：

```
vi /etc/hostname
<!--将其对应的主机名修改为新的主机名-->

vi /etc/hosts
<!--需要将 /etc/hosts 中 127.0.0.1 对应的老主机名更换为新的主机名-->

<!--重启服务器生效-->

```

修改完毕后重新 shell 登录即可

---

## (二) 为Ubuntu系统添加新的普通用户

---

在使用Ubuntu系统的过程中，一般不建议直接使用root用户，建议新建一个或多个普通用户，平时的操作都使用普通用户登录Ubuntu系统。

使用root用户登录Ubuntu系统以后，打开一个终端，在终端中执行如下Shell命令


```
sudo useradd -m roy -s /bin/bash
```

这条命令创建了可以登陆的 linziyu 用户，并使用 /bin/bash 作为 shell

接着使用如下命令为这个新用户设置密码，请按系统提示输入两次密码：

```
sudo passwd roy
```

可为roy 用户增加管理员权限，方便部署，避免一些对新手来说比较棘手的权限问题

```
sudo adduser roy sudo
```

然后，把登录用户从root用户切换到roy用户，命令如下：


```
su roy
```

---

## (三) 创建ssh公、私钥 (使用root用户)

---

```
ssh-keygen -t rsa -C "your@email.com"
```

连续回车三次即可

---

## (四) 安装docker环境

---
#### 1. 卸载旧版本docker(全新安装时，无需执行该步骤)
```
sudo apt-get remove docker docker-engine docker.io
```

#### 2. 更新系统软件
```
sudo apt-get update
```

#### 3. 安装依赖包
```
sudo apt-get install apt-transport-https ca-certificates curl software-properties-common 
```

### 4. 添加Docker官方的GPG密钥

```

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
<!--显示OK,表示添加成功.-->
<!--执行该命令时，如遇到长时间没有响应说明网络连接不到docker网站，需要使用代理进行-->

```

#### 5. 添加设置stable存储库
```
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

#### 6. 再更新一下apt包索引
```
sudo apt-get update
```

#### 7. 再更新一下apt包索引
```
sudo apt-get install docker-ce

<!--在生产系统上，可能会需要应该安装一个特定版本的Docker CE，而不是总是使用最新版本：-->
<!--apt-cache madison docker-ce--> <!--列出可用的版本-->
<!--sudo apt-get install docker-ce=<VERSION>-->
```

#### 8. 验证docker
```
<!--查看docker版本：-->
docker -v
<!--Docker version 18.06.1-ce, build e68fc7a--> <!--出现类似以上信息代表安装成功-->

<!--查看docker服务是否启动：-->
systemctl status docker

<!--若未启动，则启动docker服务：-->
sudo systemctl start docker

<!--hello world测试：-->
sudo docker run hello-world
<!--若是出现Hello from Docker字样代表成功 -->

```

#### 9. docker-compose安装
```
sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

sudo chmod +x /usr/local/bin/docker-compose

docker-compose --version
<!--docker-compose version 1.22.0, build f46880fe-->
<!--出现上述字样代表安装成功-->
```

---


## (五) 常用镜像安装准备

---
#### 1. 安装任务列表

应用程序 | 对应端口映射 （本机：docker容器）
      ---|---        
jenkins  | 8080  ： 8080         
mysql    | 3306  ： 3306        
mongo    | 27017 ： 27017      
redis    | 6379  ： 6379      
nginx    | 8765  ： 80      

#### 2. 在阿里云后台添加以上应用的安全组信息


#### 3. 在ECS服务器上创建创建如下目录

```
cd /home
sudo mkdir docker_home
<!--这个docker_home文件夹用来存放docker安装的所有应用程序的所有文件-->

<!--也就是宿主机上将要映射到容器的宿主机目录 -->

<!--比如下面的jenkins目录 之后jenkins的一些配置文件都将会存储到该目录下-->

|-- docker_home
    |-- jenkins
    |-- mongo
    |   `-- db
    |-- mysql
    |   |-- conf
    |   |-- data
    |   `-- logs
    |-- nginx
    |   |-- config
            |-- conf.d
                |-- default.conf
            |-- nginx.conf
    |   |-- logs
    |   `-- ssl
    |-- redis
    |    `-- data
    `-- adminmongo
    
        
default.conf nginx.conf两个重要nginx源文件 最好能提前准备好 
也可以在docker run 的时候不挂载，
成功启动nginx后，通过
sudo docker cp [containerId]/etc/nginx/nginx.conf /home/docker_home/nginx/config/nginx.conf 
这种形式复制nginx镜像中的源文件到本地相应文件夹 

再停止和删除nginx容器（必要的操作）
重新docker run 命令挂载

但是考虑到这两个文件一般都是有标准模板可以轻易找到 
还是自行准备比较好 避免麻烦
```


---

## (六) ubuntu下安装docker版jenkins

---

#### 1. 使用下面的命令拉取jenkins的docker镜像，这里我是用的是lts的长期支持版本，你可以到jenkins官网自由选择其他版本
```
sudo docker search jenkins
sudo docker pull jenkins/jenkins:lts
```

#### 2. 设置宿主机映射目录的所有者和所属的组

```
sudo chown -R 1000:1000 /home/docker_home/jenkins
```

#### 3. 启动jenkins的docker镜像，并设置相关参数
```
sudo docker run -d --name jenkins -p 8080:8080 -p 50000:50000 -u root \
  -v /home/docker_home/jenkins:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/bin/docker:/usr/bin/docker \
  -v /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7 \
  -v /opt:/opt \
  -v /etc/timezone:/etc/timezone jenkins/jenkins:lts
```
- ***==-d== 表示以后台模式运行***

- ***==--name== 为容器定义一个名字（后面可以代替容器id使用）***

- ***==-p== 表示映射容器的端口到宿主机的端口***

- ***==-u root== 使用root用户运行，避免后面出现的一些执行权限问题***

- ***==-v== 表示映射宿主机的目录到容器的目录***

- ***==-v /home/jenkins_home:/var/jenkins_home== 映射jenkins_home，将数据存储到宿主机，这样配置就不会随容器丢失***

- ***==-v /var/run/docker.sock:/var/run/docker.sock== 与 ==-v /usr/bin/docker:/usr/bin/docker== 把宿主机docker 映射到容器内，可以直接在容器内使用宿主机docker***

- ***==-v /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7==  容器内docker运行需要的库文件***

- ***==-v /opt:/opt==  自主安装的一些运行时软件（如java/maven/git...）***

- ***==-v /etc/timezone:/etc/timezone== 映射时区文件，保证容器的时区和宿主机相同（官网的jenkins容器时区不是中国的时区）***


---

#### 4. 容器启动后，就可以访问ip:8080看到jenkins首次运行的首页了，然后通过下面命令查看初始密码，填入之后跳转到安装插件的页面，选择第一个就好，会默认安装一些插件

```
sudo cat /home/docker_home/jenkins/secrets/initialAdminPassword
```

#### 5. 跳转到创建用户和密码的界面，创建好后，jenkins的安装也就到此结束了


## (七) ubuntu下安装docker版nginx

#### 1. 使用下面的命令拉取nginx的docker镜像
```
sudo docker search nignx
sudo docker pull nginx
```

#### 2.  启动nignx的docker镜像，并设置相关参数，创建容器

---
```
docker run --detach --name nginx -p 80:80 -p 443:443 \
-v /home/docker_home/nginx/data:/usr/share/nginx/html \
-v /home/docker_home/nginx/config/nginx.conf:/etc/nginx/nginx.conf \
-v /home/docker_home/nginx/config/conf.d:/etc/nginx/conf.d \
-v /home/docker_home/nginx/logs:/var/log/nginx \
-v /home/docker_home/nginx/ssl:/ssl \
-d nginx
```


---

#### 3. 使用想要进入交互式终端，使用如下命令
---

```
sudo docker exec -it nginx /bin/bash

```

## (八) ubuntu下安装docker版mysql

---

#### 1. 使用下面的命令拉取mysql的docker镜像，我这里安装mysql5.6版本

```
sudo docker search mysql
sudo docker pull mysql:5.6
```

#### 2. 启动mysql的docker镜像，并设置相关参数

```
cd /home/docker_home/mysql/conf
vi my.cnf
<!--wq!保存-->
```

```
sudo docker run -p 3306:3306 --name mysql \
-v /home/docker_home/mysql/conf/my.cnf:/etc/mysql/my.cnf \
-v /home/docker_home/mysql/logs:/logs \
-v /home/docker_home/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=123gogogo \
-d mysql:5.6
```
命令说明：

*/home/docker_home/mysql/data目录将映射为mysql容器配置的数据文件存放路径*

*/home/docker_home/mysql/logs目录将映射为mysql容器的日志目录*

*/home/docker_home/mysql/conf目录里的配置文件将映射为mysql容器的配置文件*

- ***==-p 3306:3306==：将容器的 3306 端口映射到主机的 3306 端口***

- ***==-v -v /home/docker_home/mysql/conf/my.cnf:/etc/mysql/my.cnf==：将主机的 /home/docker_home/mysql/conf/my.cnf挂载到容器的 /etc/mysql/my.cnf文件***

- ***==-v /home/docker_home/mysql/logs==:/logs：将主机/home/docker_home/mysql/logs 目录挂载到容器的 /logs***

- ***==-v /home/docker_home/mysql/data:/var/lib/mysql==：将主机/home/docker_home/mysql/data目录挂载到容器的 /var/lib/mysql***

- ***==-e MYSQL_ROOT_PASSWORD=123456==：初始化 root 用户的密码***


```
sudo docker ps
<!--存在mysql的容器 运行正常-->
```

测试

此时便可以在客户端使用shell或者Navicat等工具进行远程访问


#### 3. 进入容器操作

```
sudo docker exec -it mysql env LANG=C.UTF-8 bash
<!--其中 env LANG=C.UTF-8 bash 让docker命令行支持中文-->

cp /usr/my.cnf /etc/mysql/my.cnf

mysql -u root -p 123gogogo

show databases;


```

### 4. 退出mysql，退出docker
```
<!--修改my.cnf配置文件-->
sudo vi /home/docker_home/mysql/conf/my.cnf
<!--加入-->
[client] default-character-set=utf8 
[mysql] default-character-set=utf8 
[mysqld] character-set-server=utf8
<!--重启mysql容器-->
docker restart mysql
```

### 5. 添加远程登录用户

```

CREATE USER 'roy'@'%' IDENTIFIED WITH mysql_native_password BY '123gogogo!';

GRANT ALL PRIVILEGES ON *.* TO 'roy'@'%';

```
---


## (九) ubuntu下安装docker版mongodb

---

#### 1. 使用下面的命令拉取Docker Hub上的mongo镜像

```
sudo docker search mongo
sudo docker pull mongo
```

#### 2. 启动mongo的docker镜像，并设置相关参数

```
sudo docker run -p 27017:27017 --name mongo  -v /home/docker_home/mongo/db:/data/db -d mongo
```
命令说明：

- ***==-p 27017:27017==：将容器的 27017 端口映射到主机的 27017 端口***

- ***==-v /home/docker_home/mongo/db:/data/db==：将主机/home/docker_home/mongo/db目录挂载到容器的/data/db***

```
sudo docker ps
<!--存在mongo的容器 运行正常-->
```

测试

此时便可以在客户端使用shell或者MongoChef等工具进行远程访问


#### 3. 进入容器操作

```
sudo docker run -it mongo mongo --host [主机IP]

show dbs;

```

---



## (十) ubuntu下安装docker版redis

---

#### 1. 使用下面的命令拉取Docker Hub上的redis镜像

```
sudo docker search redis
sudo docker pull redis:3.2
```

#### 2. 启动redis的docker镜像，并设置相关参数

```
sudo docker run -p 6379:6379 -v /home/docker_home/redis/data:/data  -d redis:3.2 redis-server --appendonly yes
```
命令说明：

- ***==-p 6379:6379==：将容器的 6379 端口映射到主机的 6379 端口***

- ***==-v /home/docker_home/redis/data:/data==：将主机/home/docker_home/mongo/db目录挂载到容器的/data/db***

- ***==redis-server==：redis的启动命令***

- ***==--appendonly yes==：打开redis持久化配置***


```
sudo docker ps
<!--存在redis的容器 运行正常-->
```

测试

此时便可以在客户端使用shell等工具进行远程访问


#### 3. 进入容器操作

```
sudo docker rename clever_northcutt redis
有可能容器名称不是'redis'，可以通过docker rename 命令进行修改

sudo docker exec -it redis redis-cli
<!--当然使用[CONTAINER ID]也可以-->

```
---

## (十一) ubuntu下安装mongoexpress

---

#### 1. 使用下面的命令拉取Docker Hub上的mongoexpress镜像

```
docker pull mongo-express
```

#### 2. 启动mongoexpress的docker镜像，并设置相关参数

```
docker run --link mongo:mongo --name mongoexpress -p 8081:8081 -e ME_CONFIG_BASICAUTH_USERNAME="root" -e ME_CONFIG_BASICAUTH_PASSWORD="@liu4665030heng"  -d  mongo-express
```
命令说明：

- ***==--link mongo:mongo9==：与当前机器上的mongo镜像关联 才能连接到当前服务器上的mongodb***


```
sudo docker ps
<!--存在mongoexpres的容器 运行正常-->
```
---

## (十二) ubuntu下安装adminmongo

---

#### 1. 使用下面的命令拉取Docker Hub上的adminmongo镜像

```
docker pull mrvautin/adminmongo
```

#### 2. 启动adminmongo的docker镜像，并设置相关参数

```
docker run -d -e HOST=0.0.0.0 -e PASSWORD="@liu4665030heng"  -e LOCALE="zh-cn" -p 1234:1234 -v /home/docker_home/adminmongo/config:/app/user/config  --name="adminmongo" mrvautin/adminmongo
```
```
sudo docker ps
<!--存在mongoexpres的容器 运行正常-->
```


#### 3. 进入容器操作

```
sudo docker exec -it adminmongo sh

```
---

## (十二) ubuntu下安装Yapi

---

#### 1. 获取 Yapi 镜像，版本信息可在 阿里云镜像仓库 查看

```
docker pull registry.cn-hangzhou.aliyuncs.com/anoy/yapi
```

#### 2. 初始化 Yapi 数据库索引及管理员账号

```
docker run -it --link mongo:mongo --entrypoint npm --workdir /api/vendors registry.cn-hangzhou.aliyuncs.com/anoy/yapi run install-server

<!--自定义配置文件挂载到目录 /api/config.json，官方自定义配置文件-->
<!--https://github.com/YMFE/yapi/blob/master/config_example.json-->
```

#### 3. 启动 Yapi 服务

```
docker run -d --name yapi  --link mongo:mongo --workdir /api/vendors -p 8082:3000 registry.cn-hangzhou.aliyuncs.com/anoy/yapi server/app.js
```

#### 4. 使用 Yapi

```
<!--访问 http://ip:8082 登录账号 admin@admin.com，密码 ymfe.org-->
```
---